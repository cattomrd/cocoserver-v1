<!-- Archivo app/templates/device_detail.html completo con todos los cambios -->
{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Dispositivo {{device.name}}</h1>
        <a href="/ui/devices" class="btn btn-outline-secondary">Volver a la lista</a>
    </div>
    
    <!-- Botones principales de acción -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex flex-wrap gap-2">
                <button type="button" class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#editDeviceModal">
                    <i class="bi bi-pencil"></i> Editar Información
                </button>
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteDeviceModal">
                    <i class="bi bi-trash"></i> Eliminar Dispositivo
                </button>
                <a href="/api/devices/{{ device.device_id }}/ping" class="btn btn-info" id="pingButton">
                    <i class="bi bi-arrow-repeat"></i> Verificar Estado (Ping)
                </a>
                <button type="button" class="btn btn-primary" id="screenshotButton">
                    <i class="bi bi-camera"></i> Capturar Pantalla
                </button>
            </div>
        </div>
    </div>
    
    <!-- 1. Estado del Sistema -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">Estado del Sistema</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card text-center mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">CPU Temperatura</h5>
                                    <h2 class="{% if device.cpu_temp and device.cpu_temp > 70 %}text-danger{% elif device.cpu_temp and device.cpu_temp > 60 %}text-warning{% else %}text-success{% endif %}">
                                        {% if device.cpu_temp %}{{ device.cpu_temp }}°C{% else %}--{% endif %}
                                    </h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Memoria RAM</h5>
                                    <h2 class="{% if device.memory_usage and device.memory_usage > 85 %}text-danger{% elif device.memory_usage and device.memory_usage > 70 %}text-warning{% else %}text-success{% endif %}">
                                        {% if device.memory_usage %}{{ device.memory_usage }}%{% else %}--{% endif %}
                                    </h2>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card text-center mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">Uso de Disco</h5>
                                    <h2 class="{% if device.disk_usage and device.disk_usage > 90 %}text-danger{% elif device.disk_usage and device.disk_usage > 75 %}text-warning{% else %}text-success{% endif %}">
                                        {% if device.disk_usage %}{{ device.disk_usage }}%{% else %}--{% endif %}
                                    </h2>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 2. Información del Dispositivo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Información del Dispositivo</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table">
                                <tr>
                                    <th style="width: 30%">Nombre:</th>
                                    <td>{{ device.name }}</td>
                                </tr>
                                <tr>
                                    <th>ID del Dispositivo:</th>
                                    <td>{{ device.device_id }}</td>
                                </tr>
                                <tr>
                                    <th>Modelo:</th>
                                    <td>{{ device.model }}</td>
                                </tr>
                                <tr>
                                    <th>IP LAN (eth0):</th>
                                    <td>
                                        {% if device.ip_address_lan %}
                                            {{ device.ip_address_lan }}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>IP WiFi (wlan0):</th>
                                    <td>
                                        {% if device.ip_address_wifi %}
                                            {{ device.ip_address_wifi }}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Estado:</th>
                                    <td>
                                        <span id="deviceStatusBadge" class="badge {% if device.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                            {% if device.is_active %}Activo{% else %}Inactivo{% endif %}
                                        </span>
                                    </td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table">
                                <tr>
                                    <th style="width: 30%">MAC (eth0):</th>
                                    <td>{{ device.mac_address }}</td>
                                </tr>
                                <tr>
                                    <th>MAC WiFi (wlan0):</th>
                                    <td>
                                        {% if device.wlan0_mac %}
                                            {{ device.wlan0_mac }}
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Ubicación:</th>
                                    <td>{{ device.location if device.location else 'No especificada' }}</td>
                                </tr>
                                <tr>
                                    <th>Tienda:</th>
                                    <td>{{ device.tienda if device.tienda else 'No especificada' }}</td>
                                </tr>
                                <tr>
                                    <th>Lista:</th>
                                    <td>{{ device.tienda if device.tienda else 'No especificada' }}</td>
                                </tr>
                                <tr>
                                    <th>Registrado:</th>
                                    <td>{{ device.registered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                                <tr>
                                    <th>Última Actividad:</th>
                                    <td>{{ device.last_seen.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 3. Gestión de Servicios -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">Gestión de Servicios</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Servicio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                    <th>Auto-inicio</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Servicio Videoloop -->
                                <tr id="service-videoloop">
                                    <td><strong>Videoloop</strong></td>
                                    <td>
                                        <span id="videoloop-status-badge" class="badge {% if device.videoloop_status == 'running' %}bg-success{% elif device.videoloop_status == 'stopped' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {% if device.videoloop_status == 'running' %}En ejecución{% elif device.videoloop_status == 'stopped' %}Detenido{% else %}Desconocido{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if device.is_active %}
                                            <div class="btn-group btn-group-sm" id="videoloop-actions">
                                                {% if device.videoloop_status == 'running' %}
                                                    <button type="button" class="btn btn-sm btn-danger service-action" data-service="videoloop" data-action="stop">
                                                        <i class="bi bi-stop-fill me-1"></i>Detener
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-warning service-action" data-service="videoloop" data-action="restart">
                                                        <i class="bi bi-arrow-repeat me-1"></i>Reiniciar
                                                    </button>
                                                {% elif device.videoloop_status == 'stopped' %}
                                                    <button type="button" class="btn btn-sm btn-success service-action" data-service="videoloop" data-action="start">
                                                        <i class="bi bi-play-fill me-1"></i>Iniciar
                                                    </button>
                                                {% else %}
                                                    <button type="button" class="btn btn-sm btn-info service-action" data-service="videoloop" data-action="status">
                                                        <i class="bi bi-info-circle me-1"></i>Verificar
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">Dispositivo inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.is_active %}
                                            <div class="form-check form-switch">
                                                <input class="form-check-input service-enable-toggle" type="checkbox" 
                                                        id="videoloop-enabled" 
                                                        data-service="videoloop" 
                                                        {% if device.videoloop_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="videoloop-enabled">
                                                    {% if device.videoloop_enabled %}Habilitado{% else %}Deshabilitado{% endif %}
                                                </label>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                
                                <!-- Servicio Kiosk -->
                                <tr id="service-kiosk">
                                    <td><strong>Kiosk</strong></td>
                                    <td>
                                        <span id="kiosk-status-badge" class="badge {% if device.kiosk_status == 'running' %}bg-success{% elif device.kiosk_status == 'stopped' %}bg-danger{% else %}bg-secondary{% endif %}">
                                            {% if device.kiosk_status == 'running' %}En ejecución{% elif device.kiosk_status == 'stopped' %}Detenido{% else %}Desconocido{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        {% if device.is_active %}
                                            <div class="btn-group btn-group-sm" id="kiosk-actions">
                                                {% if device.kiosk_status == 'running' %}
                                                    <button type="button" class="btn btn-sm btn-danger service-action" data-service="kiosk" data-action="stop">
                                                        <i class="bi bi-stop-fill me-1"></i>Detener
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-warning service-action" data-service="kiosk" data-action="restart">
                                                        <i class="bi bi-arrow-repeat me-1"></i>Reiniciar
                                                    </button>
                                                {% elif device.kiosk_status == 'stopped' %}
                                                    <button type="button" class="btn btn-sm btn-success service-action" data-service="kiosk" data-action="start">
                                                        <i class="bi bi-play-fill me-1"></i>Iniciar
                                                    </button>
                                                {% else %}
                                                    <button type="button" class="btn btn-sm btn-info service-action" data-service="kiosk" data-action="status">
                                                        <i class="bi bi-info-circle me-1"></i>Verificar
                                                    </button>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">Dispositivo inactivo</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if device.is_active %}
                                            <div class="form-check form-switch">
                                                <input class="form-check-input service-enable-toggle" type="checkbox" 
                                                        id="kiosk-enabled" 
                                                        data-service="kiosk" 
                                                        {% if device.kiosk_enabled %}checked{% endif %}>
                                                <label class="form-check-label" for="kiosk-enabled">
                                                    {% if device.kiosk_enabled %}Habilitado{% else %}Deshabilitado{% endif %}
                                                </label>
                                            </div>
                                        {% else %}
                                            <span class="text-muted">No disponible</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Sección de resultado de acción -->
                    <div id="service-action-result" class="mt-3 d-none">
                        <div class="alert alert-info">
                            <h6 class="alert-heading">Resultado de la operación</h6>
                            <div id="service-action-message"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 4. Logs del Dispositivo -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Logs del Dispositivo</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-light" id="refreshLogsBtn" title="Actualizar logs">
                            <i class="bi bi-arrow-clockwise"></i> Actualizar
                        </button>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="log-container" style="max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; background-color: #1e1e1e; color: #f0f0f0;">
                        <pre id="deviceLogContent" class="m-0 p-3">Cargando logs...</pre>
                    </div>
                </div>
                <div class="card-footer bg-light d-flex justify-content-between">
                    <span class="small text-muted">Última actualización: <span id="lastLogUpdate">-</span></span>
                    <div>
                        <div class="form-check form-switch d-inline-block me-3">
                            <input class="form-check-input" type="checkbox" id="autoRefreshLogs">
                            <label class="form-check-label small" for="autoRefreshLogs">Auto-actualizar</label>
                        </div>
                        <select id="logLinesCount" class="form-select form-select-sm d-inline-block" style="width: auto;">
                            <option value="100">100 líneas</option>
                            <option value="300" selected>300 líneas</option>
                            <option value="500">500 líneas</option>
                            <option value="1000">1000 líneas</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de acción de servicio -->
<div class="modal fade" id="serviceActionModal" tabindex="-1" aria-labelledby="serviceActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="serviceActionModalLabel">Confirmar acción</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="serviceActionConfirmMessage">¿Está seguro que desea realizar esta acción?</p>
                <div class="d-flex justify-content-center mt-3">
                    <div class="spinner-border text-primary d-none" id="serviceActionSpinner" role="status">
                        <span class="visually-hidden">Procesando...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmServiceAction">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de edición de dispositivo -->
<div class="modal fade" id="editDeviceModal" tabindex="-1" aria-labelledby="editDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editDeviceModalLabel">Editar Dispositivo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Pestañas de navegación -->
                <ul class="nav nav-tabs mb-3" id="editTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab" aria-controls="basic" aria-selected="true">Información Básica</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="hostname-tab" data-bs-toggle="tab" data-bs-target="#hostname" type="button" role="tab" aria-controls="hostname" aria-selected="false">Cambiar Hostname</button>
                    </li>
                </ul>
                
                <!-- Contenido de las pestañas -->
                <div class="tab-content" id="editTabsContent">
                    <!-- Pestaña de información básica -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel" aria-labelledby="basic-tab">
                        <form id="basicInfoForm" action="/ui/devices/{{ device.device_id }}/update" method="post">
                            <div class="mb-3">
                                <label for="name" class="form-label">Tienda</label>
                                <input type="text" class="form-control" id="tienda" name="tienda" value="{{ device.tienda}}">
                            </div>
                            <div class="mb-3">
                                <label for="location" class="form-label">Ubicación</label>
                                <input type="text" class="form-control" id="location" name="location" value="{{ device.location or '' }}">
                            </div>
                            <div class="mb-3 form-check">
                                <input type="checkbox" class="form-check-input" id="is_active" name="is_active" {% if device.is_active %}checked{% endif %}>
                                <label class="form-check-label" for="is_active">Dispositivo activo</label>
                            </div>
                            <div class="d-flex justify-content-end">
                                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-success">Guardar cambios</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Pestaña de cambio de hostname -->
                    <div class="tab-pane fade" id="hostname" role="tabpanel" aria-labelledby="hostname-tab">
                        <div class="alert alert-warning">
                            <strong>¡Atención!</strong> Cambiar el hostname requiere acceso SSH al dispositivo con permisos sudo.
                            El dispositivo se reiniciará automáticamente para aplicar los cambios.
                        </div>
                        
                        <div class="mb-3">
                            <label for="new_hostname" class="form-label">Nuevo Hostname</label>
                            <input type="text" class="form-control" id="new_hostname" 
                                placeholder="nuevo-hostname" pattern="[a-zA-Z0-9\-]+">
                            <div class="form-text">Solo se permiten letras, números y guiones. Sin espacios ni caracteres especiales.</div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="confirm_hostname" class="form-label">Confirmar Hostname</label>
                            <input type="text" class="form-control" id="confirm_hostname" 
                                placeholder="nuevo-hostname" pattern="[a-zA-Z0-9\-]+">
                            <div id="hostnameMatchError" class="invalid-feedback">
                                Los hostnames no coinciden
                            </div>
                        </div>
                        
                        <div id="sshStatusContainer" class="mb-3 d-none">
                            <label class="form-label">Estado de la conexión SSH:</label>
                            <div id="sshStatus" class="alert alert-info">
                                Verificando conexión SSH...
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-info me-2" id="validateSshBtn">Verificar SSH</button>
                            <button type="button" class="btn btn-primary" id="submitHostnameBtn" disabled>Cambiar Hostname</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de eliminación -->
<div class="modal fade" id="deleteDeviceModal" tabindex="-1" aria-labelledby="deleteDeviceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDeviceModalLabel">Confirmar eliminación</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>¿Estás seguro de que deseas eliminar el dispositivo <strong>{{ device.name }}</strong>?</p>
                <p class="text-danger">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <form action="/ui/devices/{{ device.device_id }}/delete" method="post">
                    <button type="submit" class="btn btn-danger">Eliminar dispositivo</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de captura de pantalla -->
<div class="modal fade" id="screenshotModal" tabindex="-1" aria-labelledby="screenshotModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="screenshotModalLabel">Captura de Pantalla - {{ device.name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="d-flex justify-content-center align-items-center mb-3">
                    <div class="spinner-border text-primary" id="screenshotSpinner" role="status">
                        <span class="visually-hidden">Cargando captura...</span>
                    </div>
                </div>
                <img id="screenshotImage" class="img-fluid d-none" alt="Captura de pantalla del dispositivo">
                <div id="screenshotError" class="alert alert-danger d-none">
                    No se pudo obtener la captura de pantalla.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <a id="downloadScreenshotBtn" href="#" class="btn btn-success d-none" download="screenshot-{{ device.name }}.png">
                    <i class="bi bi-download"></i> Descargar
                </a>
                <button type="button" class="btn btn-primary" id="refreshScreenshotBtn">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar los tooltips de Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    const deviceId = '{{ device.device_id }}';

    // ===== SECCIÓN DE PING =====
    initPingFunctionality();
    
    // ===== SECCIÓN DE CAMBIO DE HOSTNAME =====
    initHostnameChangeFunctionality();
    
    // ===== SECCIÓN DE LOGS =====
    initLogsFunctionality();
    
    // ===== SECCIÓN DE GESTIÓN DE SERVICIOS =====
    initServiceManagement();

    // ===== SECCIÓN DE CAPTURA DE PANTALLA =====
    initScreenshotFunctionality();
    // ===== FUNCIONES DE INICIALIZACIÓN =====
    
    function initPingFunctionality() {
        const pingButton = document.getElementById('pingButton');
        if (!pingButton) return;
        
        pingButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Cambiar el texto del botón mientras hace la verificación
            pingButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verificando...';
            pingButton.disabled = true;
            
            // Realizar la solicitud AJAX
            fetch(`/api/devices/${deviceId}/ping`)
                .then(response => response.json())
                .then(data => {
                    // Actualizar la interfaz con el resultado
                    const statusBadge = document.getElementById('deviceStatusBadge');
                    if (statusBadge) {
                        if (data.is_active) {
                            statusBadge.className = 'badge bg-success';
                            statusBadge.textContent = 'Activo';
                        } else {
                            statusBadge.className = 'badge bg-danger';
                            statusBadge.textContent = 'Inactivo';
                        }
                    }
                    
                    // Mostrar notificación
                    const alertBox = document.createElement('div');
                    alertBox.className = `alert ${data.is_active ? 'alert-success' : 'alert-warning'} alert-dismissible fade show mt-3`;
                    alertBox.innerHTML = `
                        <strong>${data.is_active ? '¡Dispositivo Activo!' : 'Dispositivo Inactivo'}</strong>
                        <p>Ping a ${data.name} (${data.ip_address_lan || data.ip_address_wifi}): ${data.is_active ? 'Exitoso' : 'Fallido'}</p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    
                    // Insertar la notificación antes de la tabla de información
                    const cardBody = document.querySelector('.card-body');
                    cardBody.insertBefore(alertBox, cardBody.firstChild);
                    
                    // Restaurar el botón
                    pingButton.innerHTML = 'Verificar Estado (Ping)';
                    pingButton.disabled = false;
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Mostrar error
                    const cardBody = document.querySelector('.card-body');
                    const alertBox = document.createElement('div');
                    alertBox.className = 'alert alert-danger alert-dismissible fade show mt-3';
                    alertBox.innerHTML = `
                        <strong>Error</strong>
                        <p>No se pudo completar la verificación. Inténtalo de nuevo más tarde.</p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    cardBody.insertBefore(alertBox, cardBody.firstChild);
                    
                    // Restaurar el botón
                    pingButton.innerHTML = 'Verificar Estado (Ping)';
                    pingButton.disabled = false;
                });
        });
    }
    
    function initHostnameChangeFunctionality() {
        const newHostnameInput = document.getElementById('new_hostname');
        const confirmHostnameInput = document.getElementById('confirm_hostname');
        const hostnameMatchError = document.getElementById('hostnameMatchError');
        const validateSshBtn = document.getElementById('validateSshBtn');
        const submitHostnameBtn = document.getElementById('submitHostnameBtn');
        const sshStatusContainer = document.getElementById('sshStatusContainer');
        const sshStatus = document.getElementById('sshStatus');
        
        if (!newHostnameInput || !confirmHostnameInput) return;
        
        // Validar que los hostnames coinciden
        function validateHostnameMatch() {
            // Solo validar si ambos campos tienen contenido
            if (newHostnameInput.value && confirmHostnameInput.value) {
                if (newHostnameInput.value === confirmHostnameInput.value) {
                    confirmHostnameInput.classList.remove('is-invalid');
                    hostnameMatchError.style.display = 'none';
                    
                    // Verificar si ya pasamos la validación SSH
                    const sshValidated = sshStatusContainer && 
                                        !sshStatusContainer.classList.contains('d-none') && 
                                        sshStatus && 
                                        sshStatus.classList.contains('alert-success');
                    
                    // Habilitar el botón si la SSH está validada
                    if (sshValidated) {
                        submitHostnameBtn.disabled = false;
                    }
                    
                    return true;
                } else {
                    confirmHostnameInput.classList.add('is-invalid');
                    hostnameMatchError.style.display = 'block';
                    submitHostnameBtn.disabled = true;
                    return false;
                }
            }
            
            // Si algún campo está vacío, no mostrar error pero retornar false
            return false;
        }
        
        // Validar conexión SSH
        if (validateSshBtn) {
            validateSshBtn.addEventListener('click', function() {
                // Mostrar contenedor de estado
                sshStatusContainer.classList.remove('d-none');
                sshStatus.className = 'alert alert-info';
                sshStatus.textContent = 'Verificando conexión SSH...';
                validateSshBtn.disabled = true;
                
                // Realizar la solicitud de validación
                fetch(`/api/devices/${deviceId}/ssh/validate`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            sshStatus.className = 'alert alert-success';
                            sshStatus.textContent = data.message;
                            
                            // Habilitar botón de envío si ambas validaciones pasan
                            if (validateHostnameMatch()) {
                                submitHostnameBtn.disabled = false;
                            }
                        } else {
                            sshStatus.className = 'alert alert-danger';
                            sshStatus.textContent = data.message;
                            submitHostnameBtn.disabled = true;
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        sshStatus.className = 'alert alert-danger';
                        sshStatus.textContent = 'Error al verificar la conexión SSH';
                        submitHostnameBtn.disabled = true;
                    })
                    .finally(() => {
                        validateSshBtn.disabled = false;
                    });
            });
        }
        
        // Validar coincidencia al cambiar los campos
        newHostnameInput.addEventListener('input', validateHostnameMatch);
        confirmHostnameInput.addEventListener('input', validateHostnameMatch);
        
        // Manejar el cambio de hostname
        if (submitHostnameBtn) {
            submitHostnameBtn.addEventListener('click', function() {
                if (!validateHostnameMatch()) {
                    return;
                }
                
                // Mostrar indicador de carga
                submitHostnameBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Cambiando...';
                submitHostnameBtn.disabled = true;
                
                // Enviar formulario mediante AJAX
                const formData = new FormData();
                formData.append('new_hostname', newHostnameInput.value);
                
                fetch(`/api/devices/${deviceId}/hostname`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.detail || 'Error al cambiar el hostname');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    // Éxito - mostrar notificación y recargar después de un tiempo
                    if (data.reboot) {
                        // Notificar que el dispositivo se está reiniciando
                        let message = `Hostname cambiado exitosamente de ${data.old_hostname} a ${data.new_hostname}. El dispositivo se está reiniciando. `;
                        message += `La página se recargará en 90 segundos para darle tiempo al dispositivo a reiniciarse.`;
                        alert(message);
                        
                        // Esperar más tiempo para dar oportunidad al reinicio (90 segundos)
                        setTimeout(() => {
                            window.location.href = `/ui/devices/${data.new_hostname}`;
                        }, 90000); // 90 segundos
                    } else {
                        // Comportamiento anterior sin reinicio
                        alert(`Hostname cambiado exitosamente de ${data.old_hostname} a ${data.new_hostname}. La página se recargará en 3 segundos.`);
                        setTimeout(() => {
                            window.location.href = `/ui/devices/${data.new_hostname}`;
                        }, 3000); // 3 segundos
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    // Mostrar error
                    sshStatus.className = 'alert alert-danger';
                    sshStatus.textContent = error.message;
                    // Restaurar botón
                    submitHostnameBtn.innerHTML = 'Cambiar Hostname';
                    submitHostnameBtn.disabled = false;
                });
            });
        }
    }
    
    function initLogsFunctionality() {
        const deviceLogContent = document.getElementById('deviceLogContent');
        const refreshLogsBtn = document.getElementById('refreshLogsBtn');
        const lastLogUpdate = document.getElementById('lastLogUpdate');
        
        if (!deviceLogContent || !refreshLogsBtn) return;
        
        // Función para formatear la fecha actual
        function formatDateTime() {
            const now = new Date();
            return now.toLocaleString();
        }
        
        // Función para procesar el texto del log
        function processLogText(text) {
            // 1. Reemplazar literales \n con verdaderos saltos de línea
            let processedText = text.replace(/\\n/g, '\n');
            
            // 2. También eliminar comillas al principio y final si están presentes
            if (processedText.startsWith('"') && processedText.endsWith('"')) {
                processedText = processedText.substring(1, processedText.length - 1);
            }
            
            return processedText;
        }
        
        // Función para cargar los logs
        async function loadDeviceLogs() {
            try {
                // Mostrar indicador de carga
                deviceLogContent.textContent = 'Cargando logs...';
                
                // Realizar la petición al endpoint
                const response = await fetch(`/api/devices/${deviceId}/logs`);
                
                if (response.ok) {
                    // Obtener los datos de texto plano
                    const rawLogData = await response.text();
                    
                    // Procesar el texto para asegurar saltos de línea correctos
                    const processedLogData = processLogText(rawLogData);
                    
                    // Asignar el contenido procesado
                    deviceLogContent.textContent = processedLogData;
                    
                    // Resaltar diferentes niveles de log con colores
                    const formattedHtml = processedLogData
                        .replace(/ERROR/g, '<span style="color: #ff6b6b;">ERROR</span>')
                        .replace(/WARNING/g, '<span style="color: #feca57;">WARNING</span>')
                        .replace(/INFO/g, '<span style="color: #48dbfb;">INFO</span>');
                    
                    // Usar innerHTML SOLO después de procesar el HTML de forma segura
                    deviceLogContent.innerHTML = formattedHtml;
                    
                    // Actualizar la hora de la última actualización
                    if (lastLogUpdate) {
                        lastLogUpdate.textContent = formatDateTime();
                    }
                    
                    // Desplazar automáticamente al final del contenedor de logs
                    const logContainer = document.querySelector('.log-container');
                    if (logContainer) {
                        logContainer.scrollTop = logContainer.scrollHeight;
                    }
                } else {
                    // Mostrar mensaje de error en caso de fallo en la petición
                    deviceLogContent.textContent = `Error al cargar logs: ${response.status} ${response.statusText}`;
                }
            } catch (error) {
                // Mostrar mensaje de error en caso de excepción
                deviceLogContent.textContent = `Error al cargar logs: ${error.message}`;
                console.error('Error al cargar logs:', error);
            }
        }
        
        // Configurar el botón de actualizar
        refreshLogsBtn.addEventListener('click', function(event) {
            event.preventDefault();
            loadDeviceLogs();
        });
        
        // Cargar logs al iniciar la página
        loadDeviceLogs();
    }
    
    function initServiceManagement() {
        const serviceActionButtons = document.querySelectorAll('.service-action');
        const serviceEnableToggles = document.querySelectorAll('.service-enable-toggle');
        const serviceActionModal = document.getElementById('serviceActionModal');
        const confirmServiceActionBtn = document.getElementById('confirmServiceAction');
        const serviceActionSpinner = document.getElementById('serviceActionSpinner');
        const serviceActionResult = document.getElementById('service-action-result');
        const serviceActionMessage = document.getElementById('service-action-message');
        
        if (!serviceActionButtons.length || !serviceActionModal) return;
        
        // Inicializar el modal de Bootstrap
        const modal = new bootstrap.Modal(serviceActionModal);
        
        // Variables para almacenar la acción actual
        let currentService = null;
        let currentAction = null;
        
        // Función para actualizar la UI después de una acción
        function updateServiceUI(service, status, enabled) {
            const statusBadge = document.getElementById(`${service}-status-badge`);
            const actionsContainer = document.getElementById(`${service}-actions`);
            const enableToggle = document.getElementById(`${service}-enabled`);
            
            // Actualizar la badge de estado
            if (statusBadge) {
                statusBadge.className = `badge ${status === 'running' ? 'bg-success' : 'bg-danger'}`;
                statusBadge.textContent = status === 'running' ? 'En ejecución' : 'Detenido';
            }
            
            // Actualizar botones de acción
            if (actionsContainer) {
                let buttonsHtml = '';
                
                if (status === 'running') {
                    buttonsHtml = `
                        <button type="button" class="btn btn-sm btn-danger service-action" data-service="${service}" data-action="stop">
                            <i class="bi bi-stop-fill me-1"></i>Detener
                        </button>
                        <button type="button" class="btn btn-sm btn-warning service-action" data-service="${service}" data-action="restart">
                            <i class="bi bi-arrow-repeat me-1"></i>Reiniciar
                        </button>
                    `;
                } else {
                    buttonsHtml = `
                        <button type="button" class="btn btn-sm btn-success service-action" data-service="${service}" data-action="start">
                            <i class="bi bi-play-fill me-1"></i>Iniciar
                        </button>
                    `;
                }
                
                actionsContainer.innerHTML = buttonsHtml;
                
                // Volver a agregar event listeners a los nuevos botones
                actionsContainer.querySelectorAll('.service-action').forEach(button => {
                    button.addEventListener('click', handleServiceAction);
                });
            }
            
            // Actualizar toggle de habilitación
            if (enableToggle && enabled !== undefined) {
                enableToggle.checked = enabled === 'enabled';
                const label = enableToggle.nextElementSibling;
                if (label) {
                    label.textContent = enabled === 'enabled' ? 'Habilitado' : 'Deshabilitado';
                }
            }
        }
        
        // Función para manejar el clic en botones de acción
        function handleServiceAction(event) {
            const button = event.currentTarget;
            currentService = button.dataset.service;
            currentAction = button.dataset.action;
            
            // Configurar el modal de confirmación
            const confirmMessage = document.getElementById('serviceActionConfirmMessage');
            let actionText = '';
            
            switch (currentAction) {
                case 'start':
                    actionText = 'iniciar';
                    break;
                case 'stop':
                    actionText = 'detener';
                    break;
                case 'restart':
                    actionText = 'reiniciar';
                    break;
                case 'status':
                    actionText = 'verificar el estado de';
                    break;
            }
            
            confirmMessage.textContent = `¿Está seguro que desea ${actionText} el servicio ${currentService}?`;
            serviceActionSpinner.classList.add('d-none');
            
            // Mostrar el modal de confirmación
            modal.show();
        }
        
        // Función para ejecutar la acción del servicio
        async function executeServiceAction() {
            try {
                // Mostrar spinner
                serviceActionSpinner.classList.remove('d-none');
                confirmServiceActionBtn.disabled = true;
                
                // Realizar la petición a la API
                const response = await fetch(`/services/${deviceId}/service/${currentService}/${currentAction}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Error al ${currentAction} servicio: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                
                // Cerrar el modal
                modal.hide();
                
                // Mostrar resultado
                serviceActionResult.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
                serviceActionResult.classList.add(result.success ? 'alert-success' : 'alert-danger');
                serviceActionMessage.innerHTML = `
                    <strong>${result.success ? 'Éxito' : 'Error'}:</strong> ${result.message}
                    ${result.details ? `<pre class="mt-2 p-2 bg-light">${result.details}</pre>` : ''}
                `;
                
                // Actualizar UI si tuvo éxito
                if (result.success) {
                    if (currentAction === 'start' || currentAction === 'stop' || currentAction === 'restart') {
                        updateServiceUI(currentService, result.status, undefined);
                    }
                }
                
                // Desplazar a la sección de resultado
                serviceActionResult.scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                console.error('Error:', error);
                serviceActionResult.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
                serviceActionResult.classList.add('alert-danger');
                serviceActionMessage.textContent = `Error: ${error.message}`;
            } finally {
                // Ocultar spinner y rehabilitar botón
                serviceActionSpinner.classList.add('d-none');
                confirmServiceActionBtn.disabled = false;
            }
        }
        
        // Función para manejar el toggle de habilitar/deshabilitar
        async function handleServiceToggle(event) {
        const toggle = event.currentTarget;
        const service = toggle.dataset.service;
        const action = toggle.checked ? 'enable' : 'disable';
        
        console.log(`Enviando petición para ${action} servicio ${service}`);
        
        try {
            // Desactivar el toggle mientras se procesa
            toggle.disabled = true;
            
            // Mostrar la URL completa para depuración
            const url = `/services/${deviceId}/service/${service}/${action}`;
            console.log("URL:", url);
            
            // Realizar la petición a la API
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            // Loguear respuesta completa
            console.log("Respuesta:", response);
            
            if (!response.ok) {
                throw new Error(`Error al ${action} servicio: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log("Resultado:", result);
            // Cerrar el modal    
                // Mostrar resultado
                serviceActionResult.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
                serviceActionResult.classList.add(result.success ? 'alert-success' : 'alert-danger');
                serviceActionMessage.textContent = result.message;
                
                // Actualizar la UI
                if (result.success) {
                    const label = toggle.nextElementSibling;
                    if (label) {
                        label.textContent = toggle.checked ? 'Habilitado' : 'Deshabilitado';
                    }
                } else {
                    // Revertir el toggle si hubo error
                    toggle.checked = !toggle.checked;
                }
                
            } catch (error) {
                console.error('Error:', error);
                serviceActionResult.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-info');
                serviceActionResult.classList.add('alert-danger');
                serviceActionMessage.textContent = `Error: ${error.message}`;
                
                // Revertir el toggle si hubo error
                toggle.checked = !toggle.checked;
            } finally {
                // Reactivar el toggle
                toggle.disabled = false;
            }
        }
        
        // Agregar event listeners a los botones de acción
        serviceActionButtons.forEach(button => {
            button.addEventListener('click', handleServiceAction);
        });
        
        // Agregar event listener al botón de confirmación
        if (confirmServiceActionBtn) {
            confirmServiceActionBtn.addEventListener('click', executeServiceAction);
        }
        
        // Agregar event listeners a los toggles de habilitar/deshabilitar
        serviceEnableToggles.forEach(toggle => {
            toggle.addEventListener('change', handleServiceToggle);
        });
    }
    function initScreenshotFunctionality() {
        const screenshotButton = document.getElementById('screenshotButton');
        const screenshotModal = document.getElementById('screenshotModal');
        const screenshotImage = document.getElementById('screenshotImage');
        const screenshotSpinner = document.getElementById('screenshotSpinner');
        const screenshotError = document.getElementById('screenshotError');
        const downloadScreenshotBtn = document.getElementById('downloadScreenshotBtn');
        const refreshScreenshotBtn = document.getElementById('refreshScreenshotBtn');
        
        if (!screenshotButton || !screenshotModal) return;
        
        // Inicializar el modal de Bootstrap
        const modal = new bootstrap.Modal(screenshotModal);
        
        // Función para obtener y mostrar la captura de pantalla
        async function getScreenshot() {
            try {
                // Mostrar spinner y ocultar elementos previos
                screenshotSpinner.classList.remove('d-none');
                screenshotImage.classList.add('d-none');
                screenshotError.classList.add('d-none');
                downloadScreenshotBtn.classList.add('d-none');
                
                // Realizar la petición a la API
                const response = await fetch(`/services/devices/${deviceId}/screenshot`);
                
                if (!response.ok) {
                    throw new Error(`Error al obtener la captura: ${response.status} ${response.statusText}`);
                }
                
                // Obtener la imagen como blob
                const imageBlob = await response.blob();
                
                // Crear URL para la imagen
                const imageUrl = URL.createObjectURL(imageBlob);
                
                // Mostrar la imagen
                screenshotImage.src = imageUrl;
                screenshotImage.classList.remove('d-none');
                
                // Configurar botón de descarga
                downloadScreenshotBtn.href = imageUrl;
                downloadScreenshotBtn.download = `screenshot-${deviceId}-${new Date().toISOString().replace(/:/g, '-')}.png`;
                downloadScreenshotBtn.classList.remove('d-none');
                
            } catch (error) {
                console.error('Error:', error);
                screenshotError.textContent = `Error al obtener la captura: ${error.message}`;
                screenshotError.classList.remove('d-none');
            } finally {
                // Ocultar spinner
                screenshotSpinner.classList.add('d-none');
            }
        }
        
        // Event listener para el botón de captura
        screenshotButton.addEventListener('click', function() {
            modal.show();
            getScreenshot();
        });
        
        // Event listener para el botón de actualizar
        refreshScreenshotBtn.addEventListener('click', getScreenshot);
        
        // Limpiar recursos cuando se cierra el modal
        screenshotModal.addEventListener('hidden.bs.modal', function() {
            if (screenshotImage.src) {
                URL.revokeObjectURL(screenshotImage.src);
            }
        });
    }
});
</script>   
{% endblock %}
